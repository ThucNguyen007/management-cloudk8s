  dist: trusty
  sudo: required
  services:
    - docker
    
  # Get Google Chrome headless browser for Angular tests
  # Install latest Docker CE so we can use Dockerfile outside build context
  addons:
    apt:
      packages:
        - docker-ce
    
  # Install any dependencies, 
  # update Docker Compose so we can use Dockerfile outside build context
  before_install:
    - docker --version
    - docker-compose --version
    - sudo rm /usr/local/bin/docker-compose
    - curl -L https://github.com/docker/compose/releases/download/1.23.2/docker-compose-`uname -s`-`uname -m` > docker-compose
    - chmod +x docker-compose
    - sudo mv docker-compose /usr/local/bin
    - docker-compose --version
    
  #install:

  # Build development images for test
  before_script:
    - docker pull $CI_REGISTRY_IMAGE:latest || true
    - docker build --cache-from $CI_REGISTRY_IMAGE:latest --tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA .
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    
  after_success:
    # Build Production Images for deployment
    - docker-compose -f docker-compose.yaml build
    
    # Login to Docker Hub
    - echo "$DOCKER_HUB_PASSWORD" | docker login -u "$DOCKER_HUB_ID" --password-stdin
    
    # Take the built production images and push to Docker Hub
    - docker-compose -f docker-compose.yaml push